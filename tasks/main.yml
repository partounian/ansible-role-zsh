---
- name: Install required packages
  become: yes
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ zsh_dependencies }}"
  tags: packages
  when: ansible_os_family != "Darwin"
  
- name: Install required packages
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ zsh_dependencies }}"
  tags: packages
  when: ansible_os_family == "Darwin"

- name: Get zsh path
  command: which zsh 
  register: zsh_path
  changed_when: no
  tags: configuration

- name: Switch to zsh
  become: yes 
  user:
    name: "{{ item }}"
    shell: "{{ zsh_path.stdout }}"
  with_items: "{{ zsh_users }}"
  tags: configuration

- name: Clone oh-my-zsh repository
  git:
    repo: https://github.com/robbyrussell/oh-my-zsh.git
    dest: "/home/{{ item }}/.oh-my-zsh"
    accept_hostkey: yes
    update: no
  with_items: "{{ zsh_users }}"
  tags: configuration

- name: Clone oh-my-zsh custom plugin
  git:
    repo: "{{ item[1].repo }}"
    dest: "/home/{{ item[0] }}/.oh-my-zsh/custom/plugins/{{ item[1].name }}"
    accept_hostkey: yes
    update: no
  with_nested:
    - "{{ zsh_users }}"
    - "{{ zsh_ohmy_custom_plugins }}"
  tags: configuration

- name: Clone oh-my-zsh custom themes
  git:
    repo: "{{ item[1].repo }}"
    dest: "/home/{{ item[0] }}/.oh-my-zsh/custom/themes/{{ item[1].name }}"
    accept_hostkey: yes
    update: no
  with_nested:
    - "{{ zsh_users }}"
    - "{{ zsh_ohmy_custom_themes }}"
  tags: configuration

- name: Set permissions for oh my zsh dir
  file:
    path: "/home/{{ item }}/.oh-my-zsh"
    owner: "{{ item }}"
    group: "{{ item }}"
    state: directory
    recurse: yes
  with_items: "{{ zsh_users }}"
  tags: configuration

- name: Create zsh config file
  template:
    src: zsh.config.j2
    dest: "/home/{{ item }}/.zshrc"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: 0640
  with_items: "{{ zsh_users }}"
  tags: configuration

- name: Copying additional .zshrc as template to /home/user/.zshrc.local
  template:
    src: "{{zsh_append_zshrc}}"
    dest: "/home/{{ item }}/.zshrc.local"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0640"
  with_items: "{{ zsh_users }}"
  tags: configuration
  when: zsh_append_zshrc|default("") != ""
